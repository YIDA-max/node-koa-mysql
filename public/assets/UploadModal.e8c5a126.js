var J=Object.defineProperty,K=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var w=(e,o,n)=>o in e?J(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,R=(e,o)=>{for(var n in o||(o={}))X.call(o,n)&&w(e,n,o[n]);if(T)for(var n of T(o))Y.call(o,n)&&w(e,n,o[n]);return e},N=(e,o)=>K(e,Q(o));var _=(e,o,n)=>new Promise((c,a)=>{var v=u=>{try{l(n.next(u))}catch(s){a(s)}},g=u=>{try{l(n.throw(u))}catch(s){a(s)}},l=u=>u.done?c(u.value):Promise.resolve(u.value).then(v,g);l((n=n.apply(e,o)).next())});import{u as I,l as C,j as f,a as Z,b as ee,c9 as te,ca as ae,s as oe,r as A,av as ne,x,o as se,U as le,A as y,i as F,D as L,t as P,e as re,B as ue,G as ce,aA as ie,cb as pe}from"./index.10ef4608.js";/* empty css                *//* empty css                */import{b as de}from"./uuid.2429c801.js";import{B as me,b as fe}from"./index.c8f8ec06.js";import{U as h,c as ge,a as he,b as be,d as ve,g as Se}from"./data.0eb78a63.js";import{_ as Ue,b as Ce}from"./FileList.vue_vue_type_style_index_0_lang.2fb1aca4.js";import"./useAttrs.1d381a3e.js";import"./useWindowSizeFn.3e5b045d.js";import"./useModalContext.52c86736.js";/* empty css               */import"./TableAction.edf9a202.js";/* empty css               */import"./ThumbUrl.d4110d50.js";/* empty css                */const{t:B}=I();function xe({acceptRef:e,helpTextRef:o,maxNumberRef:n,maxSizeRef:c}){const a=C(()=>{const l=f(e);return l&&l.length>0?l:[]}),v=C(()=>f(a).map(l=>l.indexOf("/")>0||l.startsWith(".")?l:`.${l}`).join(",")),g=C(()=>{const l=f(o);if(l)return l;const u=[],s=f(e);s.length>0&&u.push(B("component.upload.accept",[s.join(",")]));const S=f(c);S&&u.push(B("component.upload.maxSize",[S]));const U=f(n);return U&&U!==1/0&&u.push(B("component.upload.maxNumber",[U])),u.join("\uFF0C")});return{getAccept:a,getStringAccept:v,getHelpText:g}}const ye=ee({components:{BasicModal:me,Upload:te,Alert:ae,FileList:Ue},props:N(R({},Ce),{previewFileList:{type:Array,default:()=>[]}}),emits:["change","register","delete"],setup(e,{emit:o}){const n=oe({fileList:[]}),c=A(!1),a=A([]),{accept:v,helpText:g,maxNumber:l,maxSize:u}=ne(e),{t:s}=I(),[S,{closeModal:U}]=fe(),{getAccept:M,getStringAccept:O,getHelpText:z}=xe({acceptRef:v,helpTextRef:g,maxNumberRef:l,maxSizeRef:u}),{createMessage:b}=ce(),E=C(()=>a.value.length>0&&!a.value.every(t=>t.status===h.SUCCESS)),$=C(()=>{const t=a.value.some(r=>r.status===h.SUCCESS);return{disabled:c.value||a.value.length===0||!t}}),D=C(()=>{const t=a.value.some(r=>r.status===h.ERROR);return c.value?s("component.upload.uploading"):s(t?"component.upload.reUploadFailed":"component.upload.startUpload")});function j(t){const{size:r,name:i}=t,{maxSize:p}=e,m=f(M);if(p&&t.size/1024/1024>=p)return b.error(s("component.upload.maxSizeMultiple",[p])),!1;if(m.length>0&&!be(t,m))return b.error(s("component.upload.acceptUpload",[m.join(",")])),!1;const d={uuid:de(),file:t,size:r,name:i,percent:0,type:i.split(".").pop()};return ve(t)?Se(t).then(({result:k})=>{a.value=[...f(a),R({thumbUrl:k},d)]}):a.value=[...f(a),d],!1}function W(t){const r=a.value.findIndex(i=>i.uuid===t.uuid);r!==-1&&a.value.splice(r,1),o("delete",t)}function H(t){return _(this,null,function*(){var i;const{api:r}=e;if(!r||!ie(r))return pe("upload api must exist and be a function");try{t.status=h.UPLOADING;const{data:p}=yield(i=e.api)==null?void 0:i.call(e,{data:R({},e.uploadParams||{}),file:t.file,name:e.name,filename:e.filename},function(d){const k=d.loaded/d.total*100|0;t.percent=k});return t.status=h.SUCCESS,t.responseData=p,{success:!0,error:null}}catch(p){return console.log(p),t.status=h.ERROR,{success:!1,error:p}}})}function V(){return _(this,null,function*(){var r;const{maxNumber:t}=e;if(a.value.length+((r=e.previewFileList)==null?void 0:r.length)>t)return b.warning(s("component.upload.maxNumber",[t]));try{c.value=!0;const i=a.value.filter(d=>d.status!==h.SUCCESS)||[],p=yield Promise.all(i.map(d=>H(d)));c.value=!1;const m=p.filter(d=>!d.success);if(m.length>0)throw m}catch(i){throw c.value=!1,i}})}function G(){const{maxNumber:t}=e;if(a.value.length>t)return b.warning(s("component.upload.maxNumber",[t]));if(c.value)return b.warning(s("component.upload.saveWarn"));const r=[];for(const i of a.value){const{status:p,responseData:m}=i;p===h.SUCCESS&&m&&r.push(m.url)}if(a.value.length<=0)return b.warning(s("component.upload.saveError"));a.value=[],U(),o("change",r)}function q(){return _(this,null,function*(){return c.value?(b.warning(s("component.upload.uploadWait")),!1):(a.value=[],!0)})}return{columns:ge(),actionColumn:he(W),register:S,closeModal:U,getHelpText:z,getStringAccept:O,getOkButtonProps:$,beforeUpload:j,fileListRef:a,state:n,isUploadingRef:c,handleStartUpload:V,handleOk:G,handleCloseFunc:q,getIsSelectFile:E,getUploadBtnText:D,t:s}}}),Fe={class:"upload-modal-toolbar"};function Re(e,o,n,c,a,v){const g=x("a-button"),l=x("Alert"),u=x("Upload"),s=x("FileList"),S=x("BasicModal");return se(),le(S,ue({width:"800px",title:e.t("component.upload.upload"),okText:e.t("component.upload.save")},e.$attrs,{onRegister:e.register,onOk:e.handleOk,closeFunc:e.handleCloseFunc,maskClosable:!1,keyboard:!1,wrapClassName:"upload-modal",okButtonProps:e.getOkButtonProps,cancelButtonProps:{disabled:e.isUploadingRef}}),{centerFooter:y(()=>[F(g,{onClick:e.handleStartUpload,color:"success",disabled:!e.getIsSelectFile,loading:e.isUploadingRef},{default:y(()=>[L(P(e.getUploadBtnText),1)]),_:1},8,["onClick","disabled","loading"])]),default:y(()=>[re("div",Fe,[F(l,{message:e.getHelpText,type:"info",banner:"",class:"upload-modal-toolbar__text"},null,8,["message"]),F(u,{accept:e.getStringAccept,multiple:e.multiple,"before-upload":e.beforeUpload,class:"upload-modal-toolbar__btn"},{default:y(()=>[F(g,{type:"primary"},{default:y(()=>[L(P(e.t("component.upload.choose")),1)]),_:1})]),_:1},8,["accept","multiple","before-upload"])]),F(s,{dataSource:e.fileListRef,columns:e.columns,actionColumn:e.actionColumn},null,8,["dataSource","columns","actionColumn"])]),_:1},16,["title","okText","onRegister","onOk","closeFunc","okButtonProps","cancelButtonProps"])}var je=Z(ye,[["render",Re]]);export{je as default};
