var b=(g,d,e)=>new Promise((s,p)=>{var m=o=>{try{i(e.next(o))}catch(F){p(F)}},r=o=>{try{i(e.throw(o))}catch(F){p(F)}},i=o=>o.done?s(o.value):Promise.resolve(o.value).then(m,r);i((e=e.apply(g,d)).next())});import{b as L,r as f,q as Q,o as M,c as W,i as B,A as C,j as v,cl as N,e as h,U as X,t as z,af as Y,f as Z,ab as P,D as O,cv as x,c7 as ee,aG as I}from"./index.10ef4608.js";/* empty css               *//* empty css                */import{S as ue}from"./spark-md5.2cc5764b.js";import{b as ae,u as oe,a as te,c as le}from"./updata.d7bd895d.js";import{u as se}from"./useSetFrom.689ec4a2.js";function ne(g,d,e={}){const s=new FileReader,p=new Date().getTime(),m=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,r=Math.ceil(g.size/d);let i=0;const o=new ue.ArrayBuffer,F=()=>{let D=i*d,E=D+d>=g.size?g.size:D+d;s.readAsArrayBuffer(m.call(g,D,E))};F(),s.onload=D=>{if(o.append(D.target.result),i<r)i++,F(),e.onProgress&&typeof e.onProgress=="function"&&e.onProgress(i,r);else{let E=o.end();e.onSuccess&&typeof e.onSuccess=="function"&&e.onSuccess(E),console.log(`MD5\u8BA1\u7B97\u5B8C\u6BD5\uFF1A${g.name} 
MD5\uFF1A${E} 
\u5206\u7247\uFF1A${r} \u5927\u5C0F:${g.size} \u7528\u65F6\uFF1A${new Date().getTime()-p} ms`)}},s.onerror=function(){console.log("MD5\u8BA1\u7B97\u5931\u8D25"),e.onError&&typeof e.onError=="function"&&e.onError()}}const re=O("\u91CD\u7F6E"),ve=L({__name:"upDataBasicModalItem",props:{title:String},setup(g){const d=f(),e=5*1024*1024,s=f(!1),p=f(!0),m=f(!1),r=f({current:f(0),total:f(0)}),i=f(),o=f(0),F=f([{size:0,md5:"",name:""}]),D=f([]),E=se(),U=f(),T=()=>{d.value.files[0]?p.value=!1:p.value=!0},$=()=>b(this,null,function*(){m.value=!0;const u=d.value.files[0],a=u.size,c=Math.ceil(a/e);console.log("\u6587\u4EF6\u5927\u5C0F\uFF1A",u.size/1024/1024+"Mb","\u5206\u7247\u6570\uFF1A",c),r.value.total=c,console.log(u.name),console.log(u);let t,n=!0;F.value.forEach(l=>b(this,null,function*(){l.size==a&&l.name==u.name&&l.md5!=""&&(t=l.md5,n=!1)})),n&&(t=yield V(u,e)),console.log("\u6587\u4EF6md5\uFF1A",t),console.log("\u5411\u540E\u7AEF\u8BF7\u6C42\u672C\u6B21\u5206\u7247\u4E0A\u4F20\u521D\u59CB\u5316");const S=JSON.stringify({chunkCount:c,fileName:u.name,fileMd5:t,fileSize:a});F.value.push({size:a,md5:t,name:u.name}),m.value=!1;const j=yield ae(S);yield(l=>b(this,null,function*(){const _=l.logId;if(U.value=_,E.SetUseUpBigData(_),D.value.push(_),typeof l=="string"&&(l=JSON.parse(l)),l.code===1){console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u6240\u6709\u5206\u7247\u5DF2\u5728\u4E4B\u524D\u4E0A\u4F20\u5B8C\u6210\uFF0C\u4EC5\u9700\u5408\u5E76"),console.log(l.uploadId),k(_,c,t);return}if(l.code===0){console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u79D2\u4F20"),console.log(l.url),y();return}console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u521D\u6B21\u4E0A\u4F20 \u6216 \u65AD\u70B9\u7EED\u4F20");const q=l.chunks;for(const A of q){if(!s.value)break;let w=(A.partNumber-1)*e,G=Math.min(a,w+e),H=u.slice(w,G);console.log("\u5F00\u59CB\u4E0A\u4F20\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247"),yield oe(A.uploadUrl,H),console.log("\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247\u4E0A\u4F20\u5B8C\u6210");const K=JSON.stringify({logId:_,fileMd5:t,partNumber:A.partNumber,chunkCount:c});(yield te(K))&&(r.value.current=A.partNumber,console.log("\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247\u4E0A\u4F20\u5E76\u8BB0\u5F55\u5B8C\u6210"))}k(_,c,t)}))(j)}),k=(u,a,c)=>b(this,null,function*(){console.log("\u5F00\u59CB\u8BF7\u6C42\u540E\u7AEF\u5408\u5E76\u6587\u4EF6");const t=JSON.stringify({logId:u,ifBackend:!1,chunkCount:a,fileMd5:c});let n=yield le(t);typeof n=="string"&&(n=JSON.parse(n)),n.success?(console.log("\u5408\u5E76\u6587\u4EF6\u5B8C\u6210",n),y()):console.log("\u5408\u5E76\u6587\u4EF6\u5931\u8D25\uFF01")}),J=()=>{s.value==!1?(s.value=!0,$()):s.value==!0&&(s.value=!1)},R=()=>{E.SetSetUseUpBigData();const u=[...new Set([...E.useUpBigData])],a=U.value;u.forEach((c,t)=>{c==a&&E.DelUseUpBigData(t)}),y()},y=()=>{m.value=!1,d.value.value="",s.value=!1,p.value=!0,setTimeout(()=>{r.value.total=0,r.value.current=0},1e3),i.value="",o.value=0,F.value=[]};function V(u,a){return I(()=>{}),new Promise((c,t)=>{ne(u,a,{onProgress(n,S){I(()=>{i.value="\u6821\u9A8C\u6587\u4EF6\u5B89\u5168"+(n/S*100).toFixed(0)+"%",o.value=Number((n/S*100).toFixed(0))})},onSuccess(n){c(n)},onError(){console.log(`\u6587\u4EF6${u.name}\u8BFB\u53D6\u51FA\u9519\uFF0C\u8BF7\u68C0\u67E5\u8BE5\u6587\u4EF6`),t()}})})}return Q(()=>{}),(u,a)=>(M(),W("div",null,[B(v(x),null,{default:C(()=>[B(v(N),{span:18},{default:C(()=>[h("input",{type:"file",onChange:T,id:"upload",ref_key:"updata",ref:d},null,544)]),_:1}),B(v(N),{span:5},{default:C(()=>[o.value!=0?(M(),X(v(Y),{key:0,size:"small",spinning:o.value!==100},{default:C(()=>[h("div",null,z(i.value),1)]),_:1},8,["spinning"])):Z("v-if",!0),B(v(P),{onClick:a[0]||(a[0]=()=>{J()}),disabled:p.value,loading:m.value},{default:C(()=>[O(z(s.value?"\u6682\u505C":"\u5F00\u59CB"),1)]),_:1},8,["disabled","loading"]),B(v(P),{disabled:p.value,loading:m.value,onClick:a[1]||(a[1]=()=>{R()})},{default:C(()=>[re]),_:1},8,["disabled","loading"])]),_:1})]),_:1}),B(v(x),null,{default:C(()=>[B(v(N),{span:18},{default:C(()=>[B(v(ee),{percent:Math.floor(r.value.current/r.value.total*100)},null,8,["percent"])]),_:1})]),_:1})]))}});export{ve as default};
