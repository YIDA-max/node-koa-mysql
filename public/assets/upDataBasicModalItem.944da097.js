var _=(p,o,t)=>new Promise((g,C)=>{var f=a=>{try{n(t.next(a))}catch(m){C(m)}},d=a=>{try{n(t.throw(a))}catch(m){C(m)}},n=a=>a.done?g(a.value):Promise.resolve(a.value).then(f,d);n((t=t.apply(p,o)).next())});import{b as Y,r as c,q as Z,o as I,c as ee,i as v,A as B,j as F,cl as S,D as k,t as M,e as O,U as ue,af as ae,f as te,ab as R,cv as T,c7 as le,aG as $,G as oe}from"./index.10ef4608.js";/* empty css               *//* empty css                */import{S as se}from"./spark-md5.2cc5764b.js";import{b as ne,u as re,a as ie,c as ce}from"./updata.d7bd895d.js";import{u as fe}from"./useSetFrom.689ec4a2.js";function de(p,o,t={}){const g=new FileReader,C=new Date().getTime(),f=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,d=Math.ceil(p.size/o);let n=0;const a=new se.ArrayBuffer,m=()=>{let E=n*o,D=E+o>=p.size?p.size:E+o;g.readAsArrayBuffer(f.call(p,E,D))};m(),g.onload=E=>{if(a.append(E.target.result),n<d)n++,m(),t.onProgress&&typeof t.onProgress=="function"&&t.onProgress(n,d);else{let D=a.end();t.onSuccess&&typeof t.onSuccess=="function"&&t.onSuccess(D),console.log(`MD5\u8BA1\u7B97\u5B8C\u6BD5\uFF1A${p.name} 
MD5\uFF1A${D} 
\u5206\u7247\uFF1A${d} \u5927\u5C0F:${p.size} \u7528\u65F6\uFF1A${new Date().getTime()-C} ms`)}},g.onerror=function(){console.log("MD5\u8BA1\u7B97\u5931\u8D25"),t.onError&&typeof t.onError=="function"&&t.onError()}}const Fe=k("\u91CD\u7F6E"),Ae=Y({__name:"upDataBasicModalItem",props:{getDatas:Object},setup(p){const o=p,{createMessage:t}=oe(),g=c(),C=5*1024*1024,f=c(!1),d=c(!0),n=c(!1),a=c({current:c(0),total:c(0)}),m=c(),E=c(0),D=c([{size:0,md5:"",name:""}]),J=c([]),y=fe(),w=c(),V=()=>{g.value.files[0]?d.value=!1:d.value=!0},j=()=>_(this,null,function*(){var P;n.value=!0;const e=g.value.files[0],l=e.size,u=Math.ceil(l/C);console.log("\u6587\u4EF6\u5927\u5C0F\uFF1A",e.size/1024/1024+"Mb","\u5206\u7247\u6570\uFF1A",u),a.value.total=u,console.log(e.name),console.log(e);let s,i=!0;D.value.forEach(r=>_(this,null,function*(){r.size==l&&r.name==e.name&&r.md5!=""&&(s=r.md5,i=!1)})),i&&(s=yield q(e,C)),console.log("\u6587\u4EF6md5\uFF1A",s),console.log("\u5411\u540E\u7AEF\u8BF7\u6C42\u672C\u6B21\u5206\u7247\u4E0A\u4F20\u521D\u59CB\u5316");const N=JSON.stringify({chunkCount:u,fileName:e.name,fileMd5:s,fileSize:l});if(D.value.push({size:l,md5:s,name:e.name}),n.value=!1,s!==((P=o==null?void 0:o.getDatas)==null?void 0:P.fileMd5)){t.error("\u4F60\u4E0A\u4F20\u7684\u6587\u4EF6\u4E0D\u4E00\u81F4"),z();return}const H=yield ne(N);yield(r=>_(this,null,function*(){const b=r.logId;if(w.value=b,y.SetUseUpBigData(b),J.value.push(b),typeof r=="string"&&(r=JSON.parse(r)),r.code===1){console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u6240\u6709\u5206\u7247\u5DF2\u5728\u4E4B\u524D\u4E0A\u4F20\u5B8C\u6210\uFF0C\u4EC5\u9700\u5408\u5E76"),console.log(r.uploadId),h(b,u,s);return}if(r.code===0){console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u79D2\u4F20"),console.log(r.url),U();return}console.log("\u5F53\u524D\u6587\u4EF6\u4E0A\u4F20\u60C5\u51B5\uFF1A\u521D\u6B21\u4E0A\u4F20 \u6216 \u65AD\u70B9\u7EED\u4F20");const K=r.chunks;for(const A of K){if(!f.value)break;let x=(A.partNumber-1)*C,L=Math.min(l,x+C),Q=e.slice(x,L);console.log("\u5F00\u59CB\u4E0A\u4F20\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247"),yield re(A.uploadUrl,Q),console.log("\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247\u4E0A\u4F20\u5B8C\u6210");const W=JSON.stringify({logId:b,fileMd5:s,partNumber:A.partNumber,chunkCount:u}),{success:X}=yield ie(W);if(X)a.value.current=A.partNumber,console.log("\u7B2C"+A.partNumber+"\u4E2A\u5206\u7247\u4E0A\u4F20\u5E76\u8BB0\u5F55\u5B8C\u6210");else break}h(b,u,s)}))(H)}),h=(e,l,u)=>_(this,null,function*(){console.log("\u5F00\u59CB\u8BF7\u6C42\u540E\u7AEF\u5408\u5E76\u6587\u4EF6");const s=JSON.stringify({logId:e,ifBackend:!1,chunkCount:l,fileMd5:u});let i=yield ce(s);typeof i=="string"&&(i=JSON.parse(i)),i.success?(console.log("\u5408\u5E76\u6587\u4EF6\u5B8C\u6210",i),U()):console.log("\u5408\u5E76\u6587\u4EF6\u5931\u8D25\uFF01")}),G=()=>{f.value==!1?(f.value=!0,j()):f.value==!0&&(f.value=!1)},z=()=>{y.SetSetUseUpBigData();const e=[...new Set([...y.useUpBigData])],l=w.value;e.forEach((u,s)=>{u==l&&y.DelUseUpBigData(s)}),U()},U=()=>{n.value=!1,g.value.value="",f.value=!1,d.value=!0,setTimeout(()=>{a.value.total=0,a.value.current=0},1e3),m.value="",E.value=0,D.value=[]};function q(e,l){return $(()=>{}),new Promise((u,s)=>{de(e,l,{onProgress(i,N){$(()=>{m.value="\u6821\u9A8C\u6587\u4EF6\u5B89\u5168"+(i/N*100).toFixed(0)+"%",E.value=Number((i/N*100).toFixed(0))})},onSuccess(i){u(i)},onError(){console.log(`\u6587\u4EF6${e.name}\u8BFB\u53D6\u51FA\u9519\uFF0C\u8BF7\u68C0\u67E5\u8BE5\u6587\u4EF6`),s()}})})}return Z(()=>{console.log(" ",o)}),(e,l)=>(I(),ee("div",null,[v(F(T),null,{default:B(()=>[v(F(S),{span:20},{default:B(()=>{var u;return[k(" \u6587\u4EF6\u540D\u79F0:"+M((u=o.getDatas)==null?void 0:u.fileRealName),1)]}),_:1}),v(F(S),{span:20},{default:B(()=>{var u;return[k(" \u6587\u4EF6\u5927\u5C0F: "+M(Math.ceil(((u=o==null?void 0:o.getDatas)==null?void 0:u.fileSize)/1024/1024))+"MB ",1)]}),_:1}),v(F(S),{span:18},{default:B(()=>[O("input",{type:"file",onChange:V,id:"upload",ref_key:"updata",ref:g},null,544)]),_:1}),v(F(S),{span:5},{default:B(()=>[E.value!=0?(I(),ue(F(ae),{key:0,size:"small",spinning:E.value!==100},{default:B(()=>[O("div",null,M(m.value),1)]),_:1},8,["spinning"])):te("v-if",!0),v(F(R),{onClick:l[0]||(l[0]=()=>{G()}),disabled:d.value,loading:n.value},{default:B(()=>[k(M(f.value?"\u6682\u505C":"\u5F00\u59CB"),1)]),_:1},8,["disabled","loading"]),v(F(R),{disabled:d.value,loading:n.value,onClick:l[1]||(l[1]=()=>{z()})},{default:B(()=>[Fe]),_:1},8,["disabled","loading"])]),_:1})]),_:1}),v(F(T),null,{default:B(()=>[v(F(S),{span:18},{default:B(()=>[v(F(le),{percent:Math.floor(a.value.current/a.value.total*100)},null,8,["percent"])]),_:1})]),_:1})]))}});export{Ae as default};
